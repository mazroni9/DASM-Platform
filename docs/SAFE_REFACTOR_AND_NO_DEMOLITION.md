# الالتزام بـ Safe Refactor وعدم الهدم

هذا المستند يوضح **مبادئ التحسين الآمن** في المشروع، **كيف تم تطبيقها** في التعديلات المُسلّمة، و**قواعد موجزة** لأي تعديل مستقبلي.

---

## 1. ما المقصود بـ Safe Refactor وعدم الهدم؟

| المبدأ | الوصف |
|--------|--------|
| **أقل تغيير ممكن** | نعدّل فقط ما يلزم لتحقيق المتطلب؛ لا إعادة كتابة ملفات كاملة أو تغيير واجهات بدون داعٍ. |
| **تحسينات مركزة** | كل تعديل له هدف واضح (مثلاً: تصحيح انتهاء المزاد الفوري، أو إضافة بث حدث المزايدة) وليس "تحسين عام". |
| **عدم الهدم** | لا نستبدل البنية الحالية (Routes، Controllers، Models، قنوات البث) ببنية جديدة؛ نُكمّل أو نُصحّح داخل الإطار الموجود. |
| **مبررات واضحة** | كل تغيير يمكن تفسيره: لماذا وُجدت المشكلة، ولماذا هذا الحل بالذات، وما الذي لم نمسه. |
| **الحفاظ على السلوك الظاهر** | الـ API والواجهة يبقىان متوافقين مع الاستخدام الحالي؛ أي تغيير سلوكي مقصود وموثّق. |

---

## 2. كيف طُبّقت هذه المبادئ في التعديلات المُسلّمة

### 2.1 تحسين منطق المزادات (Auction Model)

| ما تم | النهج (Safe Refactor) | ما لَم يُهدم |
|-------|------------------------|-------------|
| إضافة accessor `bid_change_percentage` | إضافة حقل محسوب في الموديل فقط، بدون تغيير الجدول أو الـ API القديم. | بنية الجداول، أسماء الحقول، مسارات الـ API. |
| تصحيح انتهاء المزاد الفوري (LIVE_INSTANT / SILENT_INSTANT) | في `updateStatusBasedOnTime()`: استثناء الفوري من استدعاء `end()` عند انتهاء الوقت حتى ينقلها `MoveCarToFixedAuctionJob` إلى FIXED. | بقية منطق `end()` و`updateStatusBasedOnTime` للأنواع الأخرى. |
| عدم تعيين السيارة `sold` في `end()` | عند بلوغ الاحتياطي لا نحدّث السيارة إلى مُباعة داخل `end()`؛ البيع يُسجّل في `acceptBid()` أو عبر Job/تسوية. | مسارات القبول والتسوية الموجودة. |
| تحديث حالة السيارة في `start()` و`acceptBid()` و`end()` | تعديلات داخل الدوال الحالية فقط (متى نضع in_auction / sold / available). | علاقات الموديلات، هيكل الـ Controllers. |

**النتيجة:** منطق أوضح واستقرار أفضل دون تغيير واجهة الـ API أو هيكل قاعدة البيانات.

---

### 2.2 ربط الواجهة بالمزادات Realtime

| ما تم | النهج (Safe Refactor) | ما لَم يُهدم |
|-------|------------------------|-------------|
| بث `NewBidEvent` من مساري المزايدة (placeBid + store) | إضافة استدعاء `broadcast()` بعد حفظ المزايدة في الـ Controller؛ بدون تغيير منطق القبول أو الـ Response. | توقيع دوال الـ Controller، شكل الـ Response، Routes. |
| قنوات `auction.{car_id}` و `auction.{auction_id}` | استخدام قنوات موجودة أو نمطها المعروف؛ إضافة قناة ثانية لضمان وصول التحديث لصفحة السيارة ولوحة التاجر. | بنية Pusher والقنوات الأخرى (auction.live، إلخ). |
| تحديث صفحة تفاصيل السيارة و useDealerSocket | الاشتراك في القناتين وربط حدث واحد (NewBidEvent) بتحديث الـ state؛ بدون استبدال نظام Pusher أو إعادة بناء الصفحات. | تصميم الصفحات، باقي الـ hooks والـ contexts. |

**النتيجة:** تحديث لحظي للسعر وعدد المزايدين دون إعادة تحميل، مع بقاء كل المسارات والشاشات الأخرى كما هي.

---

### 2.3 التوثيق و Postman

| ما تم | النهج (Safe Refactor) | ما لَم يُهدم |
|-------|------------------------|-------------|
| مستندات منطق المزاد، Endpoints، README، Safe Refactor | إضافة ملفات في `docs/` فقط؛ لا تغيير في الكود. | لا يُطبّق (توثيق فقط). |
| مجموعة Postman | ملف JSON مستقل يصف الطلبات؛ لا تأثير على الـ API أو الكود. | لا يُطبّق. |

**النتيجة:** مرجعية واضحة لأي مطوّر جديد دون المساس بالمنطق أو البنية.

---

## 3. قواعد موجزة لأي تعديل مستقبلي

1. **حدّد الهدف:** اكتب في PR أو في التعليق: ما المشكلة، وما الحل، ولماذا هذا الحل بالذات.
2. **غيّر أقل ما يكفي:** عدّل الملفات/الدوال المطلوبة فقط؛ تجنّب "تحسينات جانبية" في نفس الـ PR إلا إن كانت ضرورية.
3. **لا تكسر الواجهة:** تغيير مسارات الـ API أو شكل الـ Response أو أسماء الحقول في الـ Frontend يحتاج تنسيق وتوثيق؛ التوسيع (إضافة حقول/مسارات) أفضل من الاستبدال.
4. **اترك ما يعمل:** الأجزاء التي لا علاقة لها بالمطلوب تُترك كما هي؛ لا "تنظيف" عشوائي في ملفات كبيرة.
5. **وثّق إن لزم:** أي تغيير سلوكي (مثلاً: المزاد الفوري لا يُنهى بـ end() عند الوقت) يُذكر في التوثيق (مثل AUCTION_LOGIC_STATE_AND_RULES أو README-auctions).

---

بهذا يكون بند **الالتزام بـ Safe Refactor وعدم الهدم** موثّقاً: المبادئ واضحة، التطبيق على التعديلات المُسلّمة مذكور مع التبرير، وقواعد موجزة جاهزة للاستخدام في التعديلات القادمة.
