# منطق المزادات: State Machine، الانتقال التلقائي، آخر سعر، نسبة التغير، حالة السيارة

هذا المستند يوضح **ما تم تنفيذه** في بند "تحسين منطق المزادات (انتقال تلقائي + آخر سعر + نسبة التغير + حالة السيارة)" ويُعتبر المرجع المعتمد لهذا البند.

---

## 1. State Machine لحالة المزاد (Auction Status)

الحالات المعتمدة في النظام (Enum: `App\Enums\AuctionStatus`):

| الحالة (value) | الوصف | التحول إليها |
|----------------|-------|----------------|
| `scheduled` | المزاد مجدول ولم يبدأ | الحالة الافتراضية عند الإنشاء |
| `live` / `active` | المزاد نشط وقابل للمزايدة | عند وصول وقت البداية + موافقة غرفة التحكم، أو عند استدعاء `start()` |
| `ended` | انتهى بنجاح (السعر الحالي ≥ سعر الاحتياطي) | عند انتهاء الوقت أو قبول مزايدة فورية، مع تحقق الاحتياطي |
| `completed` | مكتمل (مرادف للانتهاء الناجح في بعض المسارات) | حسب مسار التسوية |
| `failed` | فشل (انتهى الوقت دون بلوغ سعر الاحتياطي) | عند استدعاء `end()` والسعر الحالي < الاحتياطي |
| `canceled` / `cancelled` | ملغي | إلغاء يدوي |

**مسار التشغيل العادي:**  
`Scheduled` → (وقت البداية + موافقة) → `Live` → (انتهاء الوقت أو قبول فوري) → `Ended` أو `Failed`.

- **الانتقال من Scheduled إلى Live:** يتم تلقائيًا عبر `updateStatusBasedOnTime()` عند `now >= start_time` و`control_room_approved = true`، أو عبر أمر `ActivateScheduledAuctions` (Cron)، أو يدويًا عند استدعاء `start()`.
- **الانتقال من Live إلى Ended/Failed:** يتم في `updateStatusBasedOnTime()` عند `now > end_time` (أو `extended_until`) باستدعاء `end()`؛ أو فورًا في `acceptBid()` عند المزاد الفوري الصامت عند بلوغ الاحتياطي.

---

## 2. إدارة الزمن والأنواع (Auction Type)

أنواع المزاد (Enum: `App\Enums\AuctionType`):

| النوع | الوصف | التبديل التلقائي حسب الوقت |
|-------|-------|----------------------------|
| `live` | الحراج المباشر (يحتاج بث) | 16–19 (حسب التوقيت المعتمد) |
| `live_instant` | المزاد الفوري المباشر | 19–22 |
| `silent_instant` | المزاد الفوري الصامت | 22–16 |
| `fixed` | المزاد الثابت | — |

**تحديث النوع حسب الوقت:** يتم في `updateAuctionTypeBasedOnTime()` داخل `Auction` (وفق ساعات الفترات أعلاه). عند التبديل من نوع إلى آخر قد يُحدَّث `opening_price` من `current_bid` لضمان استمرارية السعر.

---

## 3. آخر سعر (Current Bid) وحفظه

- **أين يُحفظ:** في جدول `auctions`، العمود `current_bid`.
- **متى يُحدَّث:**
  - عند كل مزايدة مقبولة في `processBid()`: `$this->current_bid = $amount` ثم `save()`.
  - عند القبول الفوري في `acceptBid()`: `$this->current_bid = $amount`.
- **عرض في الـ API:** يُعاد مع المزاد كـ `current_bid` وكذلك كـ `current_price` (accessor للتوافق مع الواجهة).

النتيجة: **آخر سعر لكل مزاد (وبالتالي لكل سيارة في مزاد) محفوظ ومحدَّث** في السجل نفسه.

---

## 4. نسبة التغير (Bid Change Percentage)

- **المقصود:** نسبة التغير من سعر الافتتاح (`opening_price`) إلى السعر الحالي (`current_bid`).
- **الصيغة:** `((current_bid - opening_price) / opening_price) * 100`، مقرّبة لخانتين عشريتين.
- **التنفيذ:** حقل محسوب (accessor) في الموديل `Auction`:
  - الاسم في الـ API: `bid_change_percentage`
  - يُرجع `null` إذا لم يكن هناك سعر افتتاح أو كان صفرًا؛ وإلا نسبة مئوية (قد تكون سالبة إذا انخفض السعر نظريًا).
- **الاستخدام:** يظهر تلقائيًا في أي استجابة API تُعيد كائن المزاد (لأنه في `$appends`).

---

## 5. حالة السيارة (Car auction_status)

السيارة المرتبطة بالمزاد لها حقل `auction_status` في جدول `cars`. القيم المؤثرة على المزاد:

| القيمة | المعنى | متى تُحدَّث |
|--------|--------|-------------|
| `available` | متاحة (ليست في مزاد أو انتهى المزاد دون بيع ولم تنتقل لمزاد آخر) | عند إنهاء المزاد بـ `end()` دون بلوغ الاحتياطي (لأنواع LIVE / FIXED فقط) |
| `in_auction` | في مزاد نشط | عند بدء المزاد `start()`؛ تبقى كذلك عند تحويل المزاد الفوري إلى مزاد ثابت (FIXED) |
| `sold` | مُباعة | عند **قبول مزايدة فورية** فقط في `acceptBid()` (لا تُحدَّث في `end()`) |

**قاعدة مهمة:** إذا **لم تُبع** السيارة مع نهاية المزاد (فوري أو غيره)، قد **تنتقل لمزاد آخر** (مثلاً مزاد ثابت FIXED) عبر `MoveCarToFixedAuctionJob`، فلا يُعاد `auction_status` إلى `available` في هذه الحالة. في `Auction::end()` **لا** نحدّث السيارة إلى `sold` عند بلوغ الاحتياطي؛ البيع الفعلي يُسجّل في `acceptBid()` أو عبر Job/تسوية لاحقة. بالنسبة للمزادات الفورية (LIVE_INSTANT / SILENT_INSTANT)، عند انتهاء الوقت دون بيع لا يُستدعى `end()` من `updateStatusBasedOnTime()` ليبقى المزاد "نشطًا" حتى يحوّله `MoveCarToFixedAuctionJob` إلى نوع FIXED.

---

## 6. ملخص الملفات ذات الصلة

| الملف / المكون | الدور |
|-----------------|--------|
| `app/Enums/AuctionStatus.php` | تعريف حالات المزاد |
| `app/Enums/AuctionType.php` | تعريف أنواع المزاد |
| `app/Models/Auction.php` | `start()`, `end()`, `processBid()`, `acceptBid()`, `updateStatusBasedOnTime()`, `updateAuctionTypeBasedOnTime()`, `getBidChangePercentageAttribute()`. تحديث حالة السيارة: في `start()` → in_auction؛ في `acceptBid()` → sold؛ في `end()` عند الفشل → available (لأنواع غير الفوري فقط). |
| `app/Console/Commands/ActivateScheduledAuctions.php` | تفعيل المزادات المجدولة عند وقت البداية (Cron) |
| `app/Jobs/UpdateCarAuctionJob.php` | تغيير نوع المزاد حسب الوقت (مثلاً إلى SILENT_INSTANT / LIVE_INSTANT) |
| `app/Jobs/MoveCarToFixedAuctionJob.php` | عند انتهاء وقت مزاد فوري (LIVE_INSTANT / SILENT_INSTANT) دون بيع: تحويل نفس المزاد إلى نوع FIXED وترك السيارة في in_auction (انتقال لمزاد تاني) |
| `app/Jobs/ProcessAuctionSaleJob.php` | معالجة البيع عند قبول مزايدة محفزة (مثلاً فوري) |

---

بهذا يكون بند **تحسين منطق المزادات (انتقال تلقائي + آخر سعر + نسبة التغير + حالة السيارة)** منفّذًا: State Machine موثّق، الانتقال التلقائي حسب الزمن والنوع معمول به، آخر سعر محفوظ، نسبة التغير محسوبة ومعروضة، وحالة السيارة محدَّثة في كل مسارات الانتهاء والقبول.
