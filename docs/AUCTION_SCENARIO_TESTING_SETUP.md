# تشغيل واجهة اختبار سيناريوهات المزادات خطوة بخطوة

## 1) تشغيل الـ Backend (Laravel)

افتح طرفية في مجلد الـ backend وشغّل:

```bash
cd backend
php artisan serve
```

المفترض يطلع لك: `Server running on [http://127.0.0.1:8000]` (أو نفس الرابط اللي مضبوط عندك).

---

## 2) التأكد من الـ Migrations

في نفس مجلد `backend` نفّذ:

```bash
php artisan migrate
```

المطلوب يكون شغّال:
- إضافة عمود `is_test` لجدول `auctions` (إن وُجدت الـ migration).
- إنشاء جدول `auction_test_runs`.
- إنشاء جدول `auction_test_events`.

لو ظهر خطأ أن الجداول موجودة مسبقاً، معناها الـ migrations اتعملت قبل كده وخلاص.

---

## 3) متغير الـ API في الـ Frontend

تأكد أن الـ Frontend بيوصّل الطلبات لـ Laravel. في ملف `.env` أو `.env.local` في مجلد `frontend`:

- إما:
  - `NEXT_PUBLIC_API_URL=http://127.0.0.1:8000`
- أو الـ proxy مضبوط يوجّه `/api` لـ الـ backend (مثل ما في `proxy.ts`).

لو بتستخدم `NEXT_PUBLIC_API_URL` يبقى الطلبات هتروح على الـ backend من المتصفح مباشرة.

---

## 4) تشغيل الـ Frontend

في طرفية ثانية:

```bash
cd frontend
npm run dev
```

بعد ما يفتح الموقع (مثلاً `http://localhost:3000`)، ادخل كـ **مستخدم أدمن** (أو أي دور عنده صلاحية اختبارات المزادات).

---

## 5) الصلاحيات المطلوبة

المستخدم اللي هتسجل دخول بيه لازم يكون عنده واحدة من:

- `auction_tests.view` — عشان تشوف الصفحة وقائمة السيناريوهات وسجل التشغيلات.
- `auction_tests.run` — عشان تضغط "تشغيل السيناريو".
- `auction_tests.view_details` — عشان تفتح "تفاصيل" لأي تشغيل.

لو الـ roles والصلاحيات بتتضرب من الـ seeders، تأكد أن دور الأدمن مربوط بصلاحيات `auction_tests.*` أو على الأقل الثلاثة اللي فوق.

---

## 6) فتح صفحة اختبارات المزادات

من الأدمن:

1. ادخل على لوحة الأدمن (مثلاً `/admin`).
2. من القائمة أو الرابط ادخل على **اختبارات المزادات** (رابط الصفحة غالباً: `/admin/auction-tests`).

هتشوف:
- في الأعلى: ملخص نتائج الاختبارات الوظيفية (القديمة).
- تحتيه: قسم **"تشغيل سيناريوهات الحمل"**.

---

## 7) تشغيل سيناريو من الواجهة

1. من القائمة المنسدلة **"السيناريو"** اختر واحد، مثلاً:
   - **حمل هادئ (Small Load)**
   - **حمل متوسط (Medium Load)**
   - **ضغط عالي (Peak Load)**
   - **سنايبر في آخر الثواني (Sniper Ending)**
   - **مزادات متعددة (Multi Auction)**

2. (اختياري) **عدد المزايدين**: لو حابب تغيّر عن الافتراضي، اكتب رقم (1–500).

3. (اختياري) **المدة بالثواني**: لو حابب تغيّر مدة المزاد، اكتب رقم (مثلاً 60 أو 120). الافتراضي حسب كل سيناريو (مثلاً 300 أو 600).

4. اضغط **"تشغيل السيناريو"**.

المتوقع:
- الزر يتحول لـ "جاري التشغيل..." لحد ما الـ backend يخلص.
- بعد ما يخلص، تظهر رسالة نجاح وتتحدّث جدولة **"سجل التشغيلات"** بتشغيلة جديدة.

---

## 8) مشاهدة النتائج

- في **سجل التشغيلات** هتشوف لكل تشغيل:
  - رقم التشغيل، اسم السيناريو، الحالة (مكتمل / فشل / جاري).
  - عدد المزايدات (ناجحة/إجمالي).
  - متوسط التأخير (ms).
  - وقت البدء.

- اضغط **"تفاصيل"** على أي صف عشان تفتح نافذة فيها:
  - تفاصيل التشغيل (عدد المستخدمين، المدة، إجمالي المزايدات، ناجحة/مرفوضة، متوسط وأقصى تأخير).
  - رسالة الخطأ لو الحالة "فشل".
  - قائمة بأول 50 حدث (نوع الحدث، التأخير، المبلغ، رسالة إن وُجدت).

---

## 9) تجربة الـ API يدوياً (اختياري)

لو حابب تجرب الـ API من Postman أو `curl`:

1. **تسجيل الدخول** والحصول على توكن (Sanctum):
   - مثلاً: `POST /api/login` بالـ email و password، وترد الـ API بالـ token.

2. **قائمة السيناريوهات:**
   ```http
   GET /api/auction-tests/scenarios
   Authorization: Bearer <token>
   ```

3. **تشغيل سيناريو:**
   ```http
   POST /api/auction-tests/scenario-runs
   Authorization: Bearer <token>
   Content-Type: application/json

   {"scenario_key": "small_load"}
   ```
   أو مع تخصيص:
   ```json
   {"scenario_key": "medium_load", "user_count": 15, "duration_seconds": 120}
   ```

4. **قائمة التشغيلات:**
   ```http
   GET /api/auction-tests/scenario-runs?page=1&per_page=10
   Authorization: Bearer <token>
   ```

5. **تفاصيل تشغيل:**
   ```http
   GET /api/auction-tests/scenario-runs/1
   Authorization: Bearer <token>
   ```

---

## ملخص سريع

| الخطوة | الأمر / الإجراء |
|--------|------------------|
| 1 | `cd backend` ثم `php artisan serve` |
| 2 | `php artisan migrate` |
| 3 | التأكد من `NEXT_PUBLIC_API_URL` أو الـ proxy في الـ frontend |
| 4 | `cd frontend` ثم `npm run dev` |
| 5 | التأكد من صلاحيات `auction_tests.view` و `auction_tests.run` للأدمن |
| 6 | فتح `/admin/auction-tests` في المتصفح |
| 7 | اختيار سيناريو ثم ضغط "تشغيل السيناريو" |
| 8 | مراجعة "سجل التشغيلات" و "تفاصيل" لكل تشغيل |

بعد كده تقدر تشغّل أي سيناريو وتشوف الـ latency والأخطاء من نفس الصفحة.
