# سجل الأخطاء الحرجة التي عولجت (أثناء الاختبار والتطوير)

هذا المستند يسجّل **قائمة رسمية** بالأخطاء الحرجة التي ظهرت أثناء تفعيل وحدة الاختبار أو تشغيل المزادات وتم إصلاحها، مع وصف مختصر وملف/المسار إن وُجد.

---

## 1. أخطاء مرتبطة بوحدة الاختبار والـ WebSocket (PR 149 وما بعده)

| # | الوصف | ما تم إصلاحه | مرجع |
|---|--------|----------------|------|
| 1 | **إصلاح WebSocket لوحدة الاختبار** | مشكلة في اتصال أو استقبال أحداث الاختبارات عبر WebSocket (قناة `admin.auction-tests`)؛ تم إصلاحها لضمان وصول النتائج للتحديث اللحظي في الـ Dashboard. | PR 149 |
| 2 | **إصلاح conflict / last conflict** | تضارب أو خطأ في تحديد "آخر مزايدة" أو حالة التضارب أثناء الاختبار أو المزايدة؛ تم معالجته لضمان اتساق الحالة. | PR 149 |

---

## 2. أخطاء في منطق المزاد والـ API (معالجة لاحقة)

| # | الوصف | ما تم إصلاحه | الملف / المسار |
|---|--------|----------------|----------------|
| 3 | **تسريب رسالة الاستثناء في استجابة 500** | في `BidController::store()` كان يتم إرجاع `$e->getMessage()` للمستخدم عند أي استثناء، مما يكشف معلومات داخلية. تم استبداله برسالة ثابتة آمنة وتسجيل التفاصيل في الـ Log فقط. | `backend/app/Http/Controllers/BidController.php` |
| 4 | **رفض مزاد نشط بحالة `active` (Legacy)** | التحقق من "المزاد نشط" كان يعتمد على `$auction->status !== AuctionStatus::ACTIVE` فقط، فالمزادات المخزنة بحالة `active` (ACTIVE_ALT) كانت تُرفض. تم استبداله بـ `$auction->isActive()` ليشمل القيمتين `live` و `active`. | `BidController::store()`, `BidController::placeBid()` |
| 5 | **عدم التحقق من نطاق المزايدة لـ SILENT_INSTANT** | في `placeBid()` كان التحقق من نطاق 90%–130% لسعر الافتتاح يُطبَّق فقط داخل شرط "النوع ليس SILENT_INSTANT"، فلم يكن يُطبَّق على SILENT_INSTANT. تم إعادة ترتيب المنطق ليطبَّق نطاق المزايدة الفورية على كل من LIVE_INSTANT و SILENT_INSTANT. | `BidController::placeBid()` |
| 6 | **استقرار الحالة: تجاهل حالة `active`** | في `StateConsistencyTestService` كان التحقق من المزاد النشط يعتمد على `$auction->status === AuctionStatus::ACTIVE->value` فيُهمل المزادات ذات الحالة `active`. تم استخدام `statusValue()` و `AuctionStatus::activeValues()` ليشمل الحالتين. | `backend/Modules/Test/Services/Tests/StateConsistencyTestService.php` |

---

## 3. أخطاء في منطق انتهاء المزاد وحالة السيارة (موثّقة في منطق المزاد)

| # | الوصف | ما تم إصلاحه | الملف |
|---|--------|----------------|------|
| 7 | **إنهاء المزاد الفوري عند انتهاء الوقت** | للمزادات من نوع LIVE_INSTANT / SILENT_INSTANT كان يُستدعى `end()` من `updateStatusBasedOnTime()` عند انتهاء الوقت، مما يغيّر حالة المزاد/السيارة قبل أن ينقلها `MoveCarToFixedAuctionJob` إلى نوع FIXED. تم استثناء الأنواع الفورية من استدعاء `end()` عند انتهاء الوقت. | `app/Models/Auction.php` — `updateStatusBasedOnTime()` |
| 8 | **تعيين السيارة `sold` في `end()` عند بلوغ الاحتياطي** | كان من الممكن تحديث السيارة إلى `sold` داخل `end()` عند بلوغ سعر الاحتياطي؛ البيع الفعلي يجب أن يُسجّل في `acceptBid()` أو عبر Job/تسوية. تم إزالة تعيين `car->sold` من `end()`. | `app/Models/Auction.php` — `end()` |

---

## 4. ما تم تنفيذه في مراجعة المنطق (هذه الجولة)

تمت مراجعة المنطق فعلياً في الكود؛ التعديلات التالية **تم تطبيقها في الكود** (ليست توثيقاً فقط):

| # | ما تم | الملف |
|---|--------|------|
| 1 | **تحديث `last_bid_time` في مسار المزايدة `store()`** | عند تحديث `current_bid` بعد قبول المزايدة لم يكن يتم تعيين `last_bid_time`، فتبقى القيمة قديمة أو null وتفشل قاعدة "وجود مزايدات ⇒ وجود last_bid_time" في اختبارات تحديث السعر. تم إضافة `$auction->last_bid_time = Carbon::now();` مع تحديث الـ auction في `BidController::store()`. | `backend/app/Http/Controllers/BidController.php` |
| 2 | **تصحيح منطق LogicTestService وربطه بالـ Dashboard** | (أ) التحقق من "المزادات النشطة معتمدة من غرفة التحكم" كان يُجرى على مزادات مجدولة (scheduled) بشرط `status === ACTIVE`؛ المزادات المجدولة دائماً status = SCHEDULED فلم يتحقق الشرط أبداً. تم نقل الفحص إلى حلقة المزادات النشطة (activeAuctions) والتحقق من `control_room_approved`. (ب) إضافة مصفوفة `details.cases` (Active_IsActive، CurrentBid_NotNegative، CurrentBid_AboveMinimum، CurrentBid_BelowMaximum، TimeRange_Valid، Active_ControlRoomApproved) مع `cases_passed` و `cases_total` لظهور نتائج اختبار المنطق في الـ Dashboard مثل باقي الفئات (X/Y و Pass/Fail لكل case). | `backend/Modules/Test/Services/Tests/LogicTestService.php` |

---

## 5. كيفية الإبلاغ عن أخطاء حرجة جديدة

عند ظهور خطأ حرج أثناء الاختبار أو التشغيل:

1. توثيق الوصف وخطوات إعادة الإنتاج في تعليق أو تذكرة.
2. إصلاح الخطأ في الكود مع commit واضح (مثلاً: `fix: وصف مختصر`).
3. إضافة صف جديد إلى الجدول المناسب أعلاه في هذا الملف (رقم، وصف، ما تم إصلاحه، الملف أو المرجع). إن كان الإصلاح في "مراجعة منطق" أضفه في القسم 4 (ما تم تنفيذه في مراجعة المنطق).

---

بهذا يكون بند **إصلاح أخطاء حرجة تظهر أثناء الاختبار** موثّقاً عبر **سجل رسمي** للأخطاء التي عولجت، مع إمكانية توسيعه عند كل إصلاح جديد.
